openapi: 3.0.0
info:
  title: Chat Service API
  description: |
    API for real-time messaging, conversations, group chats, message management, and moderation.
    
    **Automatic Chat Creation**: When project owners shortlist or accept developers (via Project Service), direct conversations are automatically created between them and associated with the project. This enables immediate communication without manual setup.
    
    **Group Chats**: Project owners can create group conversations with project names after shortlisting developers to facilitate team communication.
  version: 1.0.0

servers:
  - url: http://localhost:3004
    description: Local Chat Server

tags:
  - name: "ðŸ’¬ CHAT SERVICE - Conversations"
    description: "Chat Service: Conversation management (direct messages and groups)"
  - name: "ðŸ’¬ CHAT SERVICE - Messages"
    description: "Chat Service: Message operations (send, edit, delete, read receipts)"
  - name: "ðŸ’¬ CHAT SERVICE - Participants"
    description: "Chat Service: Participant management (add, remove, archive, favorite, mute). Group participant management is restricted to project-owners only."
  - name: "ðŸ’¬ CHAT SERVICE - Moderation"
    description: "Chat Service: Conversation flagging and moderation (Admin only)"

paths:
  /api/v1/chat/conversations:
    get:
      summary: Get all conversations for authenticated user
      description: Retrieve all conversations (direct, group, system) with filtering options
      tags:
        - "ðŸ’¬ CHAT SERVICE - Conversations"
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          description: Filter by conversation type
          schema:
            type: string
            enum: [direct, group, system, moderation]
          example: direct
        - name: archived
          in: query
          description: Filter archived conversations
          schema:
            type: boolean
          example: false
        - name: favorites
          in: query
          description: Filter favorite conversations
          schema:
            type: boolean
          example: true
        - name: flagged
          in: query
          description: Filter flagged conversations (admin only)
          schema:
            type: boolean
          example: false
        - name: search
          in: query
          description: Search conversations by name or content
          schema:
            type: string
          example: "project discussion"
        - name: role
          in: query
          description: Filter by participant role (e.g., 'project-owner' to get groups created by project-owner, 'developer' for developer participants)
          schema:
            type: string
            enum: [project-owner, developer, member]
          example: project-owner
      responses:
        "200":
          description: Conversations retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Conversations retrieved successfully"
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Conversation"
        "401":
          description: Unauthorized
        "500":
          description: Internal server error

  /api/v1/chat/conversations/direct/{otherUserId}:
    get:
      summary: Get or create direct conversation
      description: |
        Retrieve existing direct conversation between current user and another user, or create a new one if it doesn't exist.
        
        **Automatic Chat Creation**: When a project owner shortlists or accepts a developer, a direct conversation is automatically created between them and associated with the project. This endpoint can also be used manually to initiate conversations.
        
        **Note**: This operation is idempotent - if a conversation already exists between the two users, it returns the existing conversation instead of creating a duplicate.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Conversations"
      security:
        - bearerAuth: []
      parameters:
        - name: otherUserId
          in: path
          required: true
          schema:
            type: integer
          description: ID of the other user
          example: 123
        - name: projectId
          in: query
          required: false
          schema:
            type: integer
          description: Optional project ID to associate with the conversation. If provided and the conversation doesn't have a projectId, it will be updated. Used automatically when conversations are created via project service (shortlisting/accepting developers).
          example: 42
      responses:
        "200":
          description: Conversation retrieved/created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Conversation retrieved/created successfully"
                  data:
                    $ref: "#/components/schemas/Conversation"
        "400":
          description: Bad request (e.g., cannot create conversation with yourself)
        "401":
          description: Unauthorized
        "500":
          description: Internal server error

  /api/v1/chat/conversations/group:
    post:
      summary: Create group conversation
      description: |
        Create a new group conversation (Project Owners only). Only developers can be added as participants.
        
        **Use Case**: After shortlisting developers for a project, project owners can create a group chat with the project name to facilitate team communication. The group can be associated with the project for better organization.
        
        **Automatic Welcome Message**: When a group is created, an automatic welcome message is sent from the project-owner to all developers in the group, welcoming them to the project and encouraging engagement.
        
        **Permissions**: 
        - Only project owners can create groups
        - Only developers can be added as participants
        - Creator (project owner) is automatically added with role 'project-owner'
        - Added developers have role 'developer'
      tags:
        - "ðŸ’¬ CHAT SERVICE - Conversations"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Group conversation name (e.g., project name or "Project Name - Team Chat")
                  example: "E-commerce Platform - Team Chat"
                projectId:
                  type: integer
                  description: Optional project ID to associate with the group. Useful for linking group chats to specific projects after shortlisting developers.
                  example: 42
                participantIds:
                  type: array
                  description: Array of developer user IDs to add as participants (should only contain developers). Typically includes shortlisted or accepted developers. Creator (project-owner) is added automatically with role 'project-owner'. Do not include the creator's ID in this array.
                  items:
                    type: integer
                  example: [123, 456, 789]
      responses:
        "201":
          description: Group conversation created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 201
                  message:
                    type: string
                    example: "Group conversation created successfully"
                  data:
                    $ref: "#/components/schemas/Conversation"
        "400":
          description: Bad request (missing required fields)
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not project-owner)
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/participants:
    post:
      summary: Add participants to group
      description: Add developers to an existing group conversation (Project Owners only). Only group creators (project-owners who created the group) can add participants. Only developers can be added, and they will be assigned the 'developer' role.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Participants"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [participantIds]
              properties:
                participantIds:
                  type: array
                  description: Array of developer user IDs to add as participants (should only contain developers). They will be assigned the 'developer' role in the group.
                  items:
                    type: integer
                  minItems: 1
                  example: [123, 456]
      responses:
        "200":
          description: Participants added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Added 2 participant(s) to group"
                  data:
                    type: object
                    properties:
                      added:
                        type: array
                        description: Successfully added participants
                        items:
                          $ref: "#/components/schemas/Participant"
                      errors:
                        type: array
                        description: Errors encountered (if any)
                        items:
                          type: string
                        example: ["User 123 is already a participant"]
        "400":
          description: Bad request (invalid conversation type, missing participant IDs, etc.)
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not project-owner or not group creator)
        "404":
          description: Conversation not found
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/participants/{participantId}:
    delete:
      summary: Remove participant from group
      description: Remove a developer from a group conversation (Project Owners only). Only group creators (project-owners who created the group) can remove participants. Cannot remove yourself.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Participants"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
        - name: participantId
          in: path
          required: true
          schema:
            type: integer
          description: User ID of participant to remove
          example: 123
      responses:
        "200":
          description: Participant removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Participant removed from group successfully"
        "400":
          description: Bad request (invalid conversation type, cannot remove yourself, etc.)
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not project-owner or not group creator)
        "404":
          description: Conversation not found
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/messages:
    get:
      summary: Get messages for a conversation
      description: Retrieve messages for a conversation with pagination. Automatically marks messages as read when fetching.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Messages"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
        - name: limit
          in: query
          description: Maximum number of messages to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
          example: 50
        - name: offset
          in: query
          description: Number of messages to skip for pagination
          schema:
            type: integer
            default: 0
            minimum: 0
          example: 0
      responses:
        "200":
          description: Messages retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Messages retrieved successfully"
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Message"
                  pagination:
                    type: object
                    properties:
                      limit:
                        type: integer
                        example: 50
                      offset:
                        type: integer
                        example: 0
                      total:
                        type: integer
                        example: 25
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not a participant)
        "500":
          description: Internal server error

  /api/v1/chat/messages:
    post:
      summary: Send a message
      description: Send a message to a conversation. Supports text, file, image, and audio messages.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Messages"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversationId, content]
              properties:
                conversationId:
                  type: integer
                  description: ID of the conversation
                  example: 1
                content:
                  type: string
                  description: Message content
                  example: "Hello! How are you?"
                messageType:
                  type: string
                  description: Type of message
                  enum: [text, file, image, audio, system]
                  default: text
                  example: text
                fileUrl:
                  type: string
                  description: URL of the file (for file/image/audio messages)
                  example: "https://example.com/files/document.pdf"
                fileName:
                  type: string
                  description: Original file name
                  example: "document.pdf"
                fileSize:
                  type: integer
                  description: File size in bytes
                  example: 1024000
                replyToId:
                  type: integer
                  description: ID of message being replied to
                  example: 123
      responses:
        "201":
          description: Message sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 201
                  message:
                    type: string
                    example: "Message sent successfully"
                  data:
                    $ref: "#/components/schemas/Message"
        "400":
          description: Bad request (missing required fields)
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not a participant or conversation is flagged)
        "500":
          description: Internal server error

  /api/v1/chat/messages/{messageId}:
    put:
      summary: Edit a message
      description: Edit an existing message (only sender can edit)
      tags:
        - "ðŸ’¬ CHAT SERVICE - Messages"
      security:
        - bearerAuth: []
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: integer
          description: Message ID
          example: 123
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  description: Updated message content
                  example: "Hello! How are you? (edited)"
      responses:
        "200":
          description: Message edited successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Message edited successfully"
                  data:
                    $ref: "#/components/schemas/Message"
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "404":
          description: Message not found or permission denied
        "500":
          description: Internal server error

    delete:
      summary: Delete a message
      description: Soft delete a message (only sender can delete)
      tags:
        - "ðŸ’¬ CHAT SERVICE - Messages"
      security:
        - bearerAuth: []
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: integer
          description: Message ID
          example: 123
      responses:
        "200":
          description: Message deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Message deleted successfully"
                  data:
                    $ref: "#/components/schemas/Message"
        "401":
          description: Unauthorized
        "404":
          description: Message not found or permission denied
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/read:
    post:
      summary: Mark messages as read
      description: Mark messages in a conversation as read. If messageIds provided, marks only those; otherwise marks all unread messages.
      tags:
        - "ðŸ’¬ CHAT SERVICE - Messages"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                messageIds:
                  type: array
                  description: Optional array of specific message IDs to mark as read
                  items:
                    type: integer
                  example: [123, 124, 125]
      responses:
        "200":
          description: Messages marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Messages marked as read"
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/participant:
    put:
      summary: Update participant settings
      description: Update participant settings for a conversation (archive, favorite, mute)
      tags:
        - "ðŸ’¬ CHAT SERVICE - Participants"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isArchived:
                  type: boolean
                  description: Archive/unarchive the conversation
                  example: false
                isFavorite:
                  type: boolean
                  description: Mark/unmark as favorite
                  example: true
                isMuted:
                  type: boolean
                  description: Mute/unmute notifications
                  example: false
      responses:
        "200":
          description: Participant settings updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Participant settings updated successfully"
                  data:
                    $ref: "#/components/schemas/Participant"
        "400":
          description: Bad request (no updates provided)
        "401":
          description: Unauthorized
        "500":
          description: Internal server error

  /api/v1/chat/conversations/{conversationId}/flag:
    post:
      summary: Flag conversation (Admin only)
      description: Flag a conversation for moderation review
      tags:
        - "ðŸ’¬ CHAT SERVICE - Moderation"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  description: Reason for flagging the conversation
                  example: "Inappropriate content detected"
      responses:
        "200":
          description: Conversation flagged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Conversation flagged successfully"
                  data:
                    $ref: "#/components/schemas/Conversation"
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not admin)
        "500":
          description: Internal server error

    delete:
      summary: Unflag conversation (Admin only)
      description: Remove flag from a conversation
      tags:
        - "ðŸ’¬ CHAT SERVICE - Moderation"
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: integer
          description: Conversation ID
          example: 1
      responses:
        "200":
          description: Conversation unflagged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Conversation unflagged successfully"
                  data:
                    $ref: "#/components/schemas/Conversation"
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (not admin)
        "500":
          description: Internal server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Conversation:
      type: object
      properties:
        id:
          type: integer
          example: 1
        type:
          type: string
          enum: [direct, group, system, moderation]
          example: direct
        name:
          type: string
          nullable: true
          description: Name of the conversation (null for direct messages, required for groups)
          example: "Project Team Discussion"
        projectId:
          type: integer
          nullable: true
          description: Associated project ID (optional)
          example: 42
        status:
          type: string
          enum: [active, archived, deleted]
          default: active
          example: active
        isFlagged:
          type: boolean
          default: false
          example: false
        flaggedReason:
          type: string
          nullable: true
          description: Reason for flagging (if flagged)
          example: null
        flaggedAt:
          type: string
          format: date-time
          nullable: true
          example: null
        flaggedBy:
          type: integer
          nullable: true
          description: Admin ID who flagged the conversation
          example: null
        lastMessage:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              example: 123
            content:
              type: string
              example: "Hello! How are you?"
            senderId:
              type: integer
              example: 456
            timestamp:
              type: string
              format: date-time
              example: "2024-01-15T10:30:00Z"
        participant:
          type: object
          description: Current user's participant information
          properties:
            unreadCount:
              type: integer
              default: 0
              example: 5
            isArchived:
              type: boolean
              default: false
              example: false
            isFavorite:
              type: boolean
              default: false
              example: true
            isMuted:
              type: boolean
              default: false
              example: false
            lastReadAt:
              type: string
              format: date-time
              nullable: true
              example: "2024-01-15T09:00:00Z"
        otherParticipant:
          type: object
          nullable: true
          description: Other participant info for direct messages
          properties:
            id:
              type: integer
              example: 789
        participants:
          type: array
          description: All participants in the conversation
          items:
            $ref: "#/components/schemas/Participant"
        createdAt:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    Message:
      type: object
      properties:
        id:
          type: integer
          example: 123
        conversationId:
          type: integer
          example: 1
        senderId:
          type: integer
          example: 456
        content:
          type: string
          example: "Hello! How are you?"
        messageType:
          type: string
          enum: [text, file, image, audio, system]
          default: text
          example: text
        fileUrl:
          type: string
          nullable: true
          description: URL of the file (for file/image/audio messages)
          example: null
        fileName:
          type: string
          nullable: true
          description: Original file name
          example: null
        fileSize:
          type: integer
          nullable: true
          description: File size in bytes
          example: null
        replyToId:
          type: integer
          nullable: true
          description: ID of message being replied to
          example: null
        status:
          type: string
          enum: [sent, delivered, read]
          default: sent
          example: sent
        isDeleted:
          type: boolean
          default: false
          example: false
        deletedAt:
          type: string
          format: date-time
          nullable: true
          example: null
        isEdited:
          type: boolean
          default: false
          example: false
        editedAt:
          type: string
          format: date-time
          nullable: true
          example: null
        createdAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    Participant:
      type: object
      properties:
        id:
          type: integer
          example: 1
        conversationId:
          type: integer
          example: 1
        userId:
          type: integer
          example: 456
        role:
          type: string
          enum: [project-owner, developer, member]
          default: member
          description: |
            - 'project-owner': Project owner who created the group (has full permissions)
            - 'developer': Developer participant in a group conversation
            - 'member': Default role for direct message participants
          example: developer
        joinedAt:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        lastReadAt:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T09:00:00Z"
        unreadCount:
          type: integer
          default: 0
          example: 5
        isArchived:
          type: boolean
          default: false
          example: false
        isFavorite:
          type: boolean
          default: false
          example: true
        isMuted:
          type: boolean
          default: false
          example: false
        leftAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when participant left (null if still active)
          example: null
        createdAt:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
